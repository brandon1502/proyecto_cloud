<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proyectos - Orquestador Privado</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="../static/css/plantillas.css">
  <style>
    /* Ajustes para la tabla con bordes redondeados */
    .table-wrapper {
      overflow-x: auto;
      overflow-y: visible;
      border-radius: 0 0 15px 15px;
    }

    .table-container {
      border-radius: 15px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: auto;
    }

    /* Bordes redondeados en las esquinas de la tabla */
    thead tr:first-child th:first-child {
      border-top-left-radius: 0;
    }

    thead tr:first-child th:last-child {
      border-top-right-radius: 0;
    }

    tbody tr:last-child td:first-child {
      border-bottom-left-radius: 15px;
    }

    tbody tr:last-child td:last-child {
      border-bottom-right-radius: 15px;
    }

    /* Ajuste de anchos de columna m√°s compactos */
    th:nth-child(1), td:nth-child(1) { width: 15%; min-width: 140px; } /* Slice */
    th:nth-child(2), td:nth-child(2) { width: 18%; min-width: 150px; } /* Descripci√≥n */
    th:nth-child(3), td:nth-child(3) { width: 11%; min-width: 100px; } /* Creaci√≥n */
    th:nth-child(4), td:nth-child(4) { width: 11%; min-width: 100px; } /* Modificaci√≥n */
    th:nth-child(5), td:nth-child(5) { width: 7%; min-width: 60px; text-align: center; } /* vCPUs */
    th:nth-child(6), td:nth-child(6) { width: 8%; min-width: 70px; text-align: center; } /* RAM */
    th:nth-child(7), td:nth-child(7) { width: 8%; min-width: 70px; text-align: center; } /* Disco */
    th:nth-child(8), td:nth-child(8) { width: 6%; min-width: 50px; text-align: center; } /* VMs */
    th:nth-child(9), td:nth-child(9) { width: 11%; min-width: 120px; text-align: center; } /* Acciones */

    /* Hacer texto m√°s compacto */
    td {
      padding: 14px 12px;
      font-size: 13px;
    }

    th {
      padding: 12px 12px;
      font-size: 13px;
    }

    /* Reducir tama√±o de fechas */
    td:nth-child(3), td:nth-child(4) {
      font-size: 12px;
      white-space: nowrap;
    }

    
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>
        <div class="logo-icon">üîê</div>
        <span>Orquestador</span>
      </h2>
      <button class="toggle-btn" id="toggleSidebar">‚óÄ</button>
    </div>

    <nav class="sidebar-menu">
      <a href="/home" class="menu-item" id="inicioLink">
        <span class="menu-icon">üè†</span>
        <span>Inicio</span>
      </a>
      <a href="/plantillas" class="menu-item active" id="plantillasLink">
        <span class="menu-icon">üìù</span>
        <span>Plantillas</span>
      </a>

      <a href="/projects" class="menu-item" id="proyectosLink">
        <span class="menu-icon">üìÅ</span>
        <span>Proyectos</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="divider"></div>
      <a href="#" class="menu-item" id="changePasswordLink">
        <span class="menu-icon">üîë</span>
        <span>Cambiar Contrase√±a</span>
      </a>
      <a href="/auth/logout" class="menu-item" id="logoutLink">
        <span class="menu-icon">üö™</span>
        <span>Cerrar Sesi√≥n</span>
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="page-header">
      <h1>Plantillas</h1>
      <button class="btn-new" id="newTopologyBtn">
        <span>‚ûï</span> Crear Nuevo Template
      </button>
    </div>

    <div class="table-container">
      <div class="table-controls">
        <div class="show-entries">
          <span>Mostrar</span>
          <select id="entriesSelect">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span>entradas</span>
        </div>
        
        <div class="search-box">
          <label>Buscar:</label>
          <input type="text" id="searchInput" placeholder="Filtrar por nombre...">
        </div>
      </div>

      <div class="table-wrapper">
        <table id="projectsTable">
          <thead>
            <tr>
              <th>Slice</th>
              <th>Descripci√≥n</th>
              <th>Creaci√≥n</th>
              <th>Ultima modificaci√≥n</th>
              <th>vCPUs</th>
              <th>RAM (GB)</th>
              <th>Disco (GB)</th>
              <th>VMs</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td>TEL141_2025-2</td>
              <td>Plantilla b√°sica</td>
              <td>2025-08-18</td>
              <td>2025-09-15</td>
              <td>8</td>
              <td>16</td>
              <td>120</td>
              <td>3</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-action view" onclick="viewTemplate('20215433')">
                    <i class="fa-solid fa-eye"></i>
                    <span class="tooltip">Ver</span>
                  </button>
                  <button class="btn-action edit" onclick="editTemplate('20215433')">
                    <i class="fa-solid fa-pen-to-square"></i>
                    <span class="tooltip">Editar</span>
                  </button>
                  <button class="btn-action delete" onclick="deleteTemplate('20215433')">
                    <i class="fa-solid fa-trash"></i>
                    <span class="tooltip">Eliminar</span>
                  </button>
                </div>
              </td>
            </tr>
            <tr>
              <td>TEL141_2025-1</td>
              <td>Red empresarial</td>
              <td>2025-07-15</td>
              <td>2025-08-20</td>
              <td>12</td>
              <td>32</td>
              <td>240</td>
              <td>5</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-action view" onclick="viewTemplate('20215789')">
                    <i class="fa-solid fa-eye"></i>
                    <span class="tooltip">Ver</span>
                  </button>
                  <button class="btn-action edit" onclick="editTemplate('20215789')">
                    <i class="fa-solid fa-pen-to-square"></i>
                    <span class="tooltip">Editar</span>
                  </button>
                  <button class="btn-action delete" onclick="deleteTemplate('20215789')">
                    <i class="fa-solid fa-trash"></i>
                    <span class="tooltip">Eliminar</span>
                  </button>
                </div>
              </td>
            </tr>
            <tr>
              <td>TEL141_2024-2</td>
              <td>Alta disponibilidad</td>
              <td>2025-06-20</td>
              <td>2025-07-10</td>
              <td>16</td>
              <td>64</td>
              <td>480</td>
              <td>8</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-action view" onclick="viewTemplate('20214567')">
                    <i class="fa-solid fa-eye"></i>
                    <span class="tooltip">Ver</span>
                  </button>
                  <button class="btn-action edit" onclick="editTemplate('20214567')">
                    <i class="fa-solid fa-pen-to-square"></i>
                    <span class="tooltip">Editar</span>
                  </button>
                  <button class="btn-action delete" onclick="deleteTemplate('20214567')">
                    <i class="fa-solid fa-trash"></i>
                    <span class="tooltip">Eliminar</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="table-footer">
        <div style="color: #64748b; font-size: 14px;">
          Mostrando <span id="showingInfo">1 a 3 de 3</span> entradas
        </div>
        <div class="pagination">
          <button id="prevBtn">Anterior</button>
          <button class="active">1</button>
          <button id="nextBtn">Siguiente</button>
        </div>
      </div>
    </div>
  </main>

  <script>
  // ====== Desplegar: guardar en DB (/slices) y reenviar JSON a tu amigo ======
  deployBtn.addEventListener('click', async () => {
    const tplId = selectedTemplateId;
    const zone = document.querySelector('input[name="zone"]:checked')?.value || '';
    const tpl = templatesById.get(String(tplId));
    if (!tpl) return;

    // nombre del slice
    const stamp = new Date().toISOString().replace(/[-:TZ.]/g, '').slice(0,14);
    const sliceName = `${tpl.name}-${stamp}`.slice(0, 150);

    const payloadSlice = {
      template_id: Number(tplId),
      az_hint: zone,
      name: sliceName
    };

    deployBtn.disabled = true;
    const oldText = deployBtn.textContent;
    deployBtn.textContent = 'Desplegando‚Ä¶';

    try {
      // 1) Guardar slice en tu BD
      const res = await fetch('/slices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payloadSlice)
      });
      if (!res.ok) {
        const msg = await res.text().catch(() => '');
        throw new Error(msg || `HTTP ${res.status}`);
      }
      const slice = await res.json();

      // 2) Reenviar JSON guardado a la API de tu amigo
      const forwardRes = await fetch('/deployments/forward', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          template_id: Number(tplId),
          az_hint: zone,
          slice_id: slice?.slice_id ?? null
        })
      });

      // Si falla el forward, igual el slice qued√≥ guardado; notificamos claro.
      if (!forwardRes.ok) {
        const txt = await forwardRes.text().catch(() => '');
        alert('‚ö†Ô∏è Slice creado, pero fall√≥ el env√≠o a la API de despliegue: ' + (txt || forwardRes.status));
      } else {
        const respBody = await forwardRes.json().catch(() => ({}));
        console.log('Respuesta API amigo:', respBody);
        alert('‚úÖ Despliegue enviado a la API de tu amigo');
      }

      // 3) Actualiza tabla visual local
      const createdAt = slice.created_at
        ? new Date(slice.created_at).toLocaleString()
        : new Date().toLocaleString();

      const desc = tpl.description
        ? `${tpl.description} ¬∑ ${zone.toUpperCase()}`
        : `Zona: ${zone.toUpperCase()}`;

      addProjectRow({
        id: slice.slice_id,
        name: slice.name,
        description: desc,
        createdAt,
        status: (slice.status || 'PENDING').toUpperCase()
      });

      closeModal();
    } catch (err) {
      console.error(err);
      alert('‚ùå Error al desplegar: ' + (err?.message || 'desconocido'));
    } finally {
      deployBtn.disabled = false;
      deployBtn.textContent = oldText;
    }
  });
</script>


</body>
</html>