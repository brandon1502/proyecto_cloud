<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proyectos - Orquestador Privado</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="../static/css/proyectos.css" />
  <style>
    /* ===== Action buttons ===== */
    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .action-buttons .btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      cursor: pointer;
      transition: all 0.2s;
      color: #475569;
      font-size: 14px;
    }
    .action-buttons .btn:hover {
      background: #e2e8f0;
      border-color: #94a3b8;
      transform: translateY(-2px);
    }
    .action-buttons .btn i {
      pointer-events: none;
    }
    
    /* ===== Modal ===== */
    .modal-overlay {
      display:none; position:fixed; inset:0;
      background-color:rgba(30,41,59,.6); backdrop-filter:blur(4px);
      z-index:1000; animation:fadeIn .3s ease;
    }
    .modal-overlay.active { display:flex; justify-content:center; align-items:center; }
    .modal-container {
      background:#fff; border-radius:15px; width:90%; max-width:620px;
      box-shadow:0 20px 60px rgba(100,116,139,.25);
      animation:slideUp .3s ease; max-height:90vh; overflow-y:auto;
      border:2px solid #cbd5e1; scrollbar-width:none; -ms-overflow-style:none;
    }
    .modal-container::-webkit-scrollbar{display:none}
    .modal-header{ padding:28px 28px 20px; border-bottom:1px solid #e2e8f0; background:#f8fafc;}
    .modal-header h2{ margin:0; font-size:26px; color:#1e293b; font-weight:600;}
    .modal-body{ padding:28px;}
    .form-group{ margin-bottom:26px;}
    .form-group:last-child{ margin-bottom:0;}
    .form-group label{ display:block; margin-bottom:10px; font-weight:600; color:#1e293b; font-size:15px;}

    /* Zona de disponibilidad (cards con radio) */
    .zone-options{ display:grid; gap:14px; margin-top:12px;}
    .zone-option{
      display:flex; align-items:center; padding:18px; border:2px solid #e2e8f0;
      border-radius:10px; cursor:pointer; transition:.2s; background:#fff;
    }
    .zone-option:hover{ border-color:#60a5fa; background:#f8fafc; transform:translateY(-2px); box-shadow:0 4px 12px rgba(100,116,139,.1);}
    .zone-option input[type="radio"]{ margin-right:14px; width:20px; height:20px; cursor:pointer; accent-color:#60a5fa; }
    .zone-option.selected{
      border-color:#60a5fa; background:linear-gradient(90deg,rgba(125,211,252,.15) 0%, rgba(96,165,250,.05) 100%);
      box-shadow:0 2px 12px rgba(96,165,250,.2);
    }
    .zone-info{ flex:1;}
    .zone-title{ font-weight:600; color:#1e293b; margin-bottom:4px; font-size:15px;}
    .zone-description{ font-size:13px; color:#64748b;}

    .modal-footer{ padding:20px 28px; border-top:1px solid #e2e8f0; background:#f8fafc; display:flex; justify-content:flex-end; gap:12px;}
    .btn-modal{
      padding:12px 24px; border-radius:10px; font-weight:600; font-size:15px; cursor:pointer;
      transition:.3s; border:2px solid transparent; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .btn-cancel{ background:#fff; color:#475569; border-color:#e2e8f0;}
    .btn-cancel:hover{ background:#f1f5f9; border-color:#cbd5e1;}
    .btn-deploy{ background:linear-gradient(135deg,#60a5fa 0%,#3b82f6 100%); color:#fff; box-shadow:0 2px 12px rgba(96,165,250,.3);}
    .btn-deploy:hover{ background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%); transform:translateY(-2px); box-shadow:0 4px 16px rgba(96,165,250,.4);}
    .btn-deploy:disabled{ background:#cbd5e1; cursor:not-allowed; box-shadow:none; transform:none;}

    /* ====== Selector (dropdown) de plantillas ====== */
    .select {
      position: relative;
    }
    .select-trigger {
      display:flex; align-items:center; justify-content:space-between;
      width:100%; padding:12px 14px; border:2px solid #e2e8f0; border-radius:10px;
      background:#fff; cursor:pointer; transition:.2s; font-weight:600; color:#0f172a;
    }
    .select-trigger:hover { border-color:#60a5fa; background:#f8fafc; }
    .select-placeholder { color:#64748b; font-weight:500; }
    .select-caret { margin-left:12px; font-size:14px; color:#475569; }
    .select-menu {
      position:absolute; z-index:1010; top:calc(100% + 8px); left:0; right:0;
      background:#fff; border:2px solid #e2e8f0; border-radius:12px;
      box-shadow:0 14px 40px rgba(15,23,42,.15); max-height:280px; overflow:auto; display:none;
    }
    .select.open .select-menu { display:block; }
    .select-search {
      padding:10px 12px; border-bottom:1px solid #e2e8f0; background:#f8fafc;
    }
    .select-search input {
      width:100%; padding:10px 12px; border:2px solid #e2e8f0; border-radius:8px; outline:none;
    }
    .select-section { padding:8px; }
    .select-item {
      padding:10px 12px; border-radius:8px; cursor:pointer; transition:.15s; display:flex; flex-direction:column; gap:6px;
      border:2px solid transparent;
    }
    .select-item:hover { background:#f1f5f9; border-color:#e2e8f0; }
    .select-item[aria-selected="true"] { background:linear-gradient(90deg, rgba(125,211,252,.10), rgba(96,165,250,.04)); border-color:#60a5fa; }
    .item-title { font-weight:700; color:#0f172a; font-size:14px; }
    .item-meta { display:flex; flex-wrap:wrap; gap:6px; font-size:12px; color:#475569; }
    .meta-badge { background:#eef2ff; color:#3730a3; padding:3px 8px; border-radius:999px; font-weight:600; }

    .select-empty {
      padding:14px; color:#64748b; font-size:13px;
    }

    /* Resumen de plantilla seleccionada */
    .tpl-summary {
      margin-top:10px; display:none;
      padding:12px; border:2px dashed #cbd5e1; border-radius:10px; background:#f8fafc;
    }
    .tpl-summary h4 { margin:0 0 8px; font-size:14px; color:#0f172a; }
    .tpl-summary .badges { display:flex; flex-wrap:wrap; gap:8px; }
    .tpl-summary .badge { background:#ecfeff; color:#0369a1; padding:4px 8px; border-radius:999px; font-weight:600; font-size:12.5px; }

    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes slideUp{ from{transform:translateY(30px); opacity:0} to{transform:translateY(0); opacity:1} }

    /* ===== Custom SweetAlert2 Styles ===== */
    .swal-custom-popup {
      border-radius: 12px !important;
      padding: 28px !important;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.12) !important;
      border: 1px solid #e2e8f0 !important;
    }
    .swal-custom-title {
      font-size: 20px !important;
      font-weight: 600 !important;
      color: #0f172a !important;
      margin-bottom: 16px !important;
    }
    .swal-custom-html {
      margin: 0 !important;
      padding: 0 !important;
    }
    .swal-custom-confirm {
      background: #0f172a !important;
      color: white !important;
      border: none !important;
      border-radius: 8px !important;
      padding: 10px 24px !important;
      font-weight: 500 !important;
      font-size: 14px !important;
      transition: all 0.2s !important;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.15) !important;
    }
    .swal-custom-confirm:hover {
      background: #1e293b !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2) !important;
    }
    .swal-custom-cancel {
      background: white !important;
      color: #475569 !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 8px !important;
      padding: 10px 24px !important;
      font-weight: 500 !important;
      font-size: 14px !important;
      transition: all 0.2s !important;
    }
    .swal-custom-cancel:hover {
      background: #f8fafc !important;
      border-color: #cbd5e1 !important;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2><div class="logo-icon">üîê</div><span>Orquestador</span></h2>
      <button class="toggle-btn" id="toggleSidebar">‚óÄ</button>
    </div>

    <nav class="sidebar-menu">
      <a href="/home" class="menu-item" id="inicioLink"><span class="menu-icon">üè†</span><span>Inicio</span></a>
      <a href="/plantillas" class="menu-item" id="plantillasLink"><span class="menu-icon">üìù</span><span>Plantillas</span></a>
      <a href="/projects" class="menu-item active" id="proyectosLink"><span class="menu-icon">üìÅ</span><span>Proyectos</span></a>
    </nav>

    <div class="sidebar-footer">
      <div class="divider"></div>
      <a href="#" class="menu-item" id="changePasswordLink"><span class="menu-icon">üîë</span><span>Cambiar Contrase√±a</span></a>
      <a href="/auth/logout" class="menu-item" id="logoutLink"><span class="menu-icon">üö™</span><span>Cerrar Sesi√≥n</span></a>
    </div>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <div class="page-header">
      <h1>Proyectos</h1>
      <button class="btn-new" id="newTopologyBtn"><span>‚ûï</span> Desplegar plantilla</button>
    </div>

    <div class="table-container">
      <div class="table-controls">
        <div class="show-entries">
          <span>Mostrar</span>
          <select id="entriesSelect"><option>10</option><option>25</option><option>50</option><option>100</option></select>
          <span>entradas</span>
        </div>
        <div class="search-box">
          <label>Buscar:</label>
          <input type="text" id="searchInput" placeholder="Filtrar por nombre..."/>
        </div>
      </div>

      <table id="projectsTable">
        <thead>
          <tr>
            <th>Slice</th>
            <th>Descripci√≥n</th>
            <th>Creaci√≥n</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <div class="table-footer">
        <div style="color:#64748b; font-size:14px;">Mostrando <span id="showingInfo">0 a 0 de 0</span> entradas</div>
        <div class="pagination">
          <button id="prevBtn">Anterior</button>
          <button class="active">1</button>
          <button id="nextBtn">Siguiente</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal-overlay" id="deployModal">
    <div class="modal-container">
      <div class="modal-header"><h2>Desplegar Topolog√≠a</h2></div>

      <div class="modal-body">
        <!-- Plantillas del usuario (selector) -->
        <div class="form-group">
          <label for="templateSelectTrigger">Seleccionar Plantilla</label>
          <div class="select" id="templateSelect" aria-haspopup="listbox" aria-expanded="false">
            <button class="select-trigger" id="templateSelectTrigger" type="button" aria-controls="templateSelectMenu">
              <span class="select-value"><span class="select-placeholder">Elige una plantilla‚Ä¶</span></span>
              <span class="select-caret">‚ñæ</span>
            </button>
            <div class="select-menu" id="templateSelectMenu" role="listbox" tabindex="-1">
              <div class="select-search">
                <input id="templateSearch" type="text" placeholder="Buscar plantilla‚Ä¶" aria-label="Buscar plantilla">
              </div>
              <div class="select-section" id="templateItems"></div>
              <div class="select-empty" id="templateEmptyHint" style="display:none;">No tienes plantillas todav√≠a.</div>
            </div>
          </div>

          <!-- Resumen visible al elegir -->
          <div class="tpl-summary" id="templateSummary">
            <h4>Resumen de plantilla seleccionada</h4>
            <div class="badges" id="templateSummaryBadges"></div>
          </div>
        </div>

        <!-- Zona -->
        <div class="form-group">
          <label>Zona de Disponibilidad</label>
          <div class="zone-options">
            <label class="zone-option" for="zone1">
              <input type="radio" name="zone" id="zone1" value="zone1"/>
              <div class="zone-info">
                <div class="zone-title">Zona 1</div>
                <div class="zone-description">1 servidor disponible</div>
              </div>
            </label>
            <label class="zone-option" for="zone2">
              <input type="radio" name="zone" id="zone2" value="zone2"/>
              <div class="zone-info">
                <div class="zone-title">Zona 2</div>
                <div class="zone-description">2 servidores disponibles</div>
              </div>
            </label>
            <label class="zone-option" for="zone3">
              <input type="radio" name="zone" id="zone3" value="zone3"/>
              <div class="zone-info">
                <div class="zone-title">Zona 3</div>
                <div class="zone-description">4 servidores disponibles</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-modal btn-cancel" id="cancelBtn">Cancelar</button>
        <button class="btn-modal btn-deploy" id="deployBtn" disabled>Desplegar</button>
      </div>
    </div>
  </div>

  <script>
  /* ===== Sidebar ===== */
  const toggleBtn = document.getElementById('toggleSidebar');
  const sidebar = document.querySelector('.sidebar');
  const mainContent = document.querySelector('.main-content');
  toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('expanded');
    toggleBtn.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
  });

  /* ===== Tabla ===== */
  const tableBody = document.getElementById('tableBody');
  const showingInfo = document.getElementById('showingInfo');
  function updateShowingInfo() {
    const rows = tableBody.querySelectorAll('tr');
    const visible = Array.from(rows).filter(r => r.style.display !== 'none').length;
    showingInfo.textContent = visible ? `1 a ${visible} de ${visible}` : `0 a 0 de 0`;
  }

  /* ===== Modal ===== */
  const modal = document.getElementById('deployModal');
  const newTopologyBtn = document.getElementById('newTopologyBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const deployBtn = document.getElementById('deployBtn');

  // Template selector elements
  const templateSelect = document.getElementById('templateSelect');
  const templateSelectTrigger = document.getElementById('templateSelectTrigger');
  const templateSelectMenu = document.getElementById('templateSelectMenu');
  const templateItems = document.getElementById('templateItems');
  const templateSearch = document.getElementById('templateSearch');
  const templateEmptyHint = document.getElementById('templateEmptyHint');

  // Summary
  const tplSummary = document.getElementById('templateSummary');
  const tplSummaryBadges = document.getElementById('templateSummaryBadges');

  // Zones
  const zoneRadios = document.querySelectorAll('input[name="zone"]');
  const zoneOptions = document.querySelectorAll('.zone-option');

  // Cache
  const templatesById = new Map();
  let selectedTemplateId = null;

  // Abrir modal y cargar plantillas
  newTopologyBtn.addEventListener('click', async () => {
    await loadUserTemplates();
    openModal();
    validateForm();
  });

  function openModal() {
    modal.classList.add('active');
    document.addEventListener('keydown', escToClose);
  }
  function closeModal() {
    modal.classList.remove('active');
    document.removeEventListener('keydown', escToClose);
    resetForm();
  }
  function escToClose(e){ if(e.key === 'Escape') closeModal(); }

  // Cerrar modal
  cancelBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

  function resetForm() {
    selectedTemplateId = null;
    setSelectValue(null);
    zoneRadios.forEach(r => r.checked = false);
    zoneOptions.forEach(opt => opt.classList.remove('selected'));
    tplSummary.style.display = 'none';
    tplSummaryBadges.innerHTML = '';
    deployBtn.disabled = true;
  }

  // Selecci√≥n de zona (est√©tica)
  zoneOptions.forEach(option => {
    option.addEventListener('click', () => {
      zoneOptions.forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
      const radio = option.querySelector('input[type="radio"]');
      if (radio) radio.checked = true;
      validateForm();
    });
  });

  // ===== Dropdown behavior =====
  function toggleSelect(open) {
    const shouldOpen = typeof open === 'boolean' ? open : !templateSelect.classList.contains('open');
    templateSelect.classList.toggle('open', shouldOpen);
    templateSelect.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
    if (shouldOpen) {
      templateSearch.value = '';
      filterItems('');
      templateSearch.focus();
    }
  }
  templateSelectTrigger.addEventListener('click', () => toggleSelect());

  // Cerrar si clic fuera
  document.addEventListener('click', (e) => {
    if (!templateSelect.contains(e.target)) toggleSelect(false);
  });

  // B√∫squeda
  templateSearch.addEventListener('input', (e) => filterItems(e.target.value.trim().toLowerCase()));
  function filterItems(term) {
    const items = templateItems.querySelectorAll('.select-item');
    let visibleCount = 0;
    items.forEach(it => {
      const text = it.dataset.search || '';
      const show = text.includes(term);
      it.style.display = show ? '' : 'none';
      if (show) visibleCount++;
    });
    templateEmptyHint.style.display = (templatesById.size === 0 || visibleCount === 0) ? 'block' : 'none';
  }

  function setSelectValue(tpl) {
    const valueSpan = templateSelectTrigger.querySelector('.select-value');
    if (!tpl) {
      valueSpan.innerHTML = '<span class="select-placeholder">Elige una plantilla‚Ä¶</span>';
      tplSummary.style.display = 'none';
      return;
    }
    valueSpan.textContent = tpl.name;
    const meta = [
      `${tpl.vm_count ?? 0} VMs`,
      `${tpl.sum_vcpu ?? 0} vCPU`,
      `${Number(tpl.sum_ram_gb ?? 0).toFixed(2)} GB RAM`,
      `${Number(tpl.sum_disk_gb ?? 0).toFixed(2)} GB Disco`
    ];
    tplSummaryBadges.innerHTML = meta.map(m => `<span class="badge">${m}</span>`).join('');
    tplSummary.style.display = 'block';
  }

  // Validaci√≥n
  function validateForm() {
    const tplSelected = !!selectedTemplateId;
    const zoneSelected = Array.from(zoneRadios).some(r => r.checked);
    deployBtn.disabled = !(tplSelected && zoneSelected);
  }

  // Cargar plantillas del usuario
  async function loadUserTemplates() {
    deployBtn.disabled = true;
    templatesById.clear();
    templateItems.innerHTML = '';
    selectedTemplateId = null;
    setSelectValue(null);
    templateEmptyHint.style.display = 'none';

    try {
      const res = await fetch('/templates/mostrar_plantilla', { credentials: 'include' });
      if (!res.ok) throw new Error('No se pudieron cargar las plantillas');
      const data = await res.json();

      if (!data.length) {
        templateEmptyHint.style.display = 'block';
        return;
      }

      data.forEach(t => {
        const id = String(t.template_id);
        templatesById.set(id, t);

        const meta = [
          `${t.vm_count ?? 0} VMs`,
          `${t.sum_vcpu ?? 0} vCPU`,
          `${Number(t.sum_ram_gb ?? 0).toFixed(2)} GB RAM`,
          `${Number(t.sum_disk_gb ?? 0).toFixed(2)} GB Disco`
        ];

        const item = document.createElement('div');
        item.className = 'select-item';
        item.setAttribute('role', 'option');
        item.setAttribute('tabindex', '0');
        item.dataset.id = id;
        item.dataset.search = `${(t.name || '').toLowerCase()} ${meta.join(' ').toLowerCase()}`;
        item.innerHTML = `
          <span class="item-title">${t.name}</span>
          <div class="item-meta">
            ${meta.map(m => `<span class="meta-badge">${m}</span>`).join('')}
          </div>
        `;

        function choose() {
          selectedTemplateId = id;
          Array.from(templateItems.children).forEach(el => el.setAttribute('aria-selected', String(el.dataset.id === id)));
          setSelectValue(t);
          toggleSelect(false);
          validateForm();
        }
        item.addEventListener('click', choose);
        item.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); choose(); }
        });

        templateItems.appendChild(item);
      });
    } catch (e) {
      console.error(e);
      alert('‚ùå Error cargando tus plantillas');
    }
  }

  // ====== Desplegar: guardar en DB (/slices) ======
  deployBtn.addEventListener('click', async () => {
  const tplId = selectedTemplateId;
  const zone = document.querySelector('input[name="zone"]:checked')?.value || '';
  const tplMeta = templatesById.get(String(tplId)); // resumen de la card
  if (!tplId || !tplMeta) return;

  // nombre del slice: <nombre-plantilla>-YYYYMMDDHHMMSS
  const stamp = new Date().toISOString().replace(/[-:TZ.]/g, '').slice(0,14);
  const sliceName = `${tplMeta.name}-${stamp}`.slice(0, 150); // limite

  deployBtn.disabled = true;
  const oldText = deployBtn.textContent;
  deployBtn.textContent = 'Desplegando‚Ä¶';

  try {
    // 1. Pedir al backend que obtenga el json_template y lo env√≠e al servidor de despliegue
    //    El backend ya NO necesita que le env√≠es topology, √©l lo busca en la BD
    const externalDeployPayload = {
      name: sliceName,
      zone_hint: zone,
      template_id: Number(tplId),
      // ‚ùå YA NO enviar topology aqu√≠, el backend lo obtiene de la BD
    };

    const triggerRes = await fetch('/deployments/trigger', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(externalDeployPayload),
    });

    if (!triggerRes.ok) {
      const errorData = await triggerRes.json().catch(() => ({ detail: 'Error desconocido' }));
      throw new Error(errorData.detail || `Error HTTP ${triggerRes.status}`);
    }

    // Leer respuesta del servidor de despliegue
    const triggerInfo = await triggerRes.json();
    console.log('Respuesta del servidor de despliegue:', triggerInfo);

    // 2. Registrar el slice en tu propia BD, para mostrarlo en tabla
    const recordPayload = {
      template_id: Number(tplId),
      az_hint: zone,
      name: sliceName,
      worker_job_id: triggerInfo.worker_job_id || null,
    };

    const recordRes = await fetch('/slices', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(recordPayload),
    });

    if (!recordRes.ok) {
      const errorData = await recordRes.json().catch(() => ({ detail: 'Error desconocido' }));
      throw new Error(errorData.detail || `Error guardando slice (HTTP ${recordRes.status})`);
    }

    const slice = await recordRes.json();

    // 3. Actualizar tabla en el frontend
    const createdAt = slice.created_at
      ? new Date(slice.created_at).toLocaleString()
      : new Date().toLocaleString();

    const desc = tplMeta.description
      ? `${tplMeta.description} ¬∑ ${zone.toUpperCase()}`
      : `Zona: ${zone.toUpperCase()}`;

    addProjectRow({
      id: slice.slice_id,
      name: slice.name,
      description: desc,
      createdAt,
      status: (slice.status || 'PENDING').toUpperCase(),
    });

    // Mostrar SweetAlert2 personalizado y luego cerrar el modal
    Swal.fire({
      title: 'Despliegue enviado',
      html: `<p style="margin:0; color:#475569; font-size:14px;">El despliegue fue enviado y registrado.</p>`,
      icon: 'success',
      confirmButtonText: 'Entendido',
      customClass: {
        popup: 'swal-custom-popup',
        title: 'swal-custom-title',
        confirmButton: 'swal-custom-confirm'
      },
      buttonsStyling: false
    }).then(() => {
      closeModal();
    });

  } catch (err) {
    console.error('Error completo:', err);
    alert('‚ùå Error al desplegar: ' + (err?.message || 'desconocido'));
  } finally {
    deployBtn.disabled = false;
    deployBtn.textContent = oldText;
  }
});



  // Tabla: agregar fila
  function addProjectRow({ id, name, description, createdAt, status }) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${name}</td>
      <td>${description || '-'}</td>
      <td>${createdAt}</td>
      <td><span class="status-badge ${statusClass(status)}">${status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="btn" title="Ver detalles del slice" onclick="viewSlice(${id})">
            <i class="fa-solid fa-eye"></i>
          </button>
          <button class="btn" title="Destruir slice" onclick="destroySlice(${id}, '${name}')">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </td>
    `;
    tableBody.appendChild(tr);
    updateShowingInfo();
  }
  function statusClass(status) {
    if (status === 'RUNNING') return 'status-running';
    if (status === 'STOPPED') return 'status-stopped';
    return 'status-running'; // PENDING -> estilo parecido a running
  }

  // Search tabla
  document.getElementById('searchInput').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(term) ? '' : 'none';
    });
    updateShowingInfo();
  });

  // Tabla vac√≠a al inicio
  document.addEventListener('DOMContentLoaded', () => {
    tableBody.innerHTML = '';
    updateShowingInfo();
    loadSlices();
  });

async function loadSlices() {
  try {
    // pide tus proyectos/slices del usuario
    const res = await fetch('/slices', { credentials: 'include' });
    if (!res.ok) throw new Error('No se pudieron cargar los despliegues');
    const data = await res.json(); // [{slice_id, name, status, created_at, description}, ...]

    // limpia tabla
    tableBody.innerHTML = '';

    data.forEach(s => {
      const createdAt = s.created_at ? new Date(s.created_at).toLocaleString() : '-';
      addProjectRow({
        id: s.slice_id,
        name: s.name,
        description: s.description || '-',
        createdAt,
        status: (s.status || 'PENDING').toUpperCase(),
      });
    });

    updateShowingInfo();
  } catch (e) {
    console.error(e);
    alert('‚ùå Error cargando tus proyectos');
  }
}


async function fetchTemplateDetail(tplId) {
  const res = await fetch(`/templates/${tplId}`, {
    credentials: 'include', // manda cookie/sesi√≥n si es necesario
  });
  if (!res.ok) {
    throw new Error(`No se pudo obtener template ${tplId}`);
  }
  return await res.json(); // { template_id, name, ..., json_template: {...} }
}

// ===== Ver detalles del slice =====
function viewSlice(sliceId) {
  // Redirigir a una p√°gina de detalles (puedes crear esta vista despu√©s)
  window.location.href = `/projects/${sliceId}`;
}

// ===== Destruir slice =====
async function destroySlice(sliceId, sliceName) {
  // Confirmaci√≥n con SweetAlert2 personalizado
  const result = await Swal.fire({
    title: 'Confirmar destrucci√≥n',
    html: `
      <div style="text-align: left; padding: 8px 0;">
        <p style="margin: 0 0 16px 0; color: #1e293b; font-size: 15px;">
          Est√°s a punto de destruir el slice:
        </p>
        <div style="background: #f8fafc; border-left: 3px solid #94a3b8; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px;">
          <strong style="color: #0f172a; font-size: 15px;">${sliceName}</strong>
        </div>
        <p style="margin: 0; color: #64748b; font-size: 14px; line-height: 1.5;">
          Esta acci√≥n es permanente y no se puede deshacer.
        </p>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#0f172a',
    cancelButtonColor: '#e2e8f0',
    confirmButtonText: 'Destruir',
    cancelButtonText: 'Cancelar',
    reverseButtons: true,
    focusCancel: true,
    customClass: {
      popup: 'swal-custom-popup',
      title: 'swal-custom-title',
      htmlContainer: 'swal-custom-html',
      confirmButton: 'swal-custom-confirm',
      cancelButton: 'swal-custom-cancel',
    },
    buttonsStyling: false,
  });

  if (!result.isConfirmed) return;

  // Mostrar loading elegante
  Swal.fire({
    title: 'Procesando...',
    html: `
      <div style="padding: 20px 0;">
        <p style="margin: 0; color: #64748b; font-size: 14px;">
          Enviando solicitud de destrucci√≥n para <strong style="color: #0f172a;">${sliceName}</strong>
        </p>
      </div>
    `,
    allowOutsideClick: false,
    allowEscapeKey: false,
    showConfirmButton: false,
    customClass: {
      popup: 'swal-custom-popup',
      title: 'swal-custom-title',
    },
    didOpen: () => {
      Swal.showLoading();
    }
  });
  
  try {
    const res = await fetch(`/slices/${sliceId}/destroy`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ detail: 'Error desconocido' }));
      throw new Error(errorData.detail || `Error HTTP ${res.status}`);
    }

    const response = await res.json();
    console.log('Respuesta del servidor de destrucci√≥n:', response);

    await loadSlices();

    // Mensaje de √©xito elegante
    if (response.note) {
      await Swal.fire({
        title: 'Destrucci√≥n iniciada',
        html: `
          <div style="text-align: left; padding: 8px 0;">
            <p style="margin: 0 0 12px 0; color: #1e293b; font-size: 14px;">
              El slice ha sido eliminado de la base de datos y la destrucci√≥n est√° en progreso.
            </p>
            <div style="background: #f8fafc; border-left: 3px solid #60a5fa; padding: 10px 14px; border-radius: 6px;">
              <p style="margin: 0; color: #475569; font-size: 13px; line-height: 1.4;">
                ${response.note}
              </p>
            </div>
          </div>
        `,
        icon: 'info',
        confirmButtonText: 'Entendido',
        customClass: {
          popup: 'swal-custom-popup',
          title: 'swal-custom-title',
          confirmButton: 'swal-custom-confirm',
        },
        buttonsStyling: false,
      });
    } else {
      await Swal.fire({
        title: 'Completado',
        html: `
          <p style="margin: 0; color: #1e293b; font-size: 14px;">
            El slice <strong>${sliceName}</strong> ha sido eliminado exitosamente.
          </p>
        `,
        icon: 'success',
        timer: 2500,
        timerProgressBar: true,
        showConfirmButton: false,
        customClass: {
          popup: 'swal-custom-popup',
          title: 'swal-custom-title',
        },
      });
    }

  } catch (err) {
    console.error('Error destruyendo slice:', err);
    await Swal.fire({
      title: 'Error al destruir',
      html: `
        <div style="text-align: left; padding: 8px 0;">
          <p style="margin: 0 0 12px 0; color: #1e293b; font-size: 14px;">
            No se pudo completar la destrucci√≥n del slice.
          </p>
          <div style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 10px 14px; border-radius: 6px;">
            <code style="color: #dc2626; font-size: 13px; font-family: 'Courier New', monospace;">
              ${err.message}
            </code>
          </div>
        </div>
      `,
      icon: 'error',
      confirmButtonText: 'Cerrar',
      customClass: {
        popup: 'swal-custom-popup',
        title: 'swal-custom-title',
        confirmButton: 'swal-custom-confirm',
      },
      buttonsStyling: false,
    });
  }
}



</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>
</html>
