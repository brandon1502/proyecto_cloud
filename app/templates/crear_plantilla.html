<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dise√±ador de Topolog√≠a de VMs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css" rel="stylesheet">
    <style>

        .modern-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
}

.modern-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.switch-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #cbd5e1;
    transition: .3s;
    border-radius: 34px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

.switch-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.modern-switch input:checked + .switch-slider {
    background-color: #64748b;
}

.modern-switch input:checked + .switch-slider:before {
    transform: translateX(22px);
}

.modern-switch input:focus + .switch-slider {
    box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.2);
}    

.form-group {
    margin-bottom: 20px;
    background: transparent; /* Sin fondo gris */
    padding: 0; /* Sin padding extra */
    border: none; /* Sin bordes */
    box-shadow: none; /* Sin sombras */
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #1e293b;
}

.form-group input[type="text"],
.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    background: white;
    transition: border-color 0.2s;
}

.form-group input[type="text"]:focus,
.form-group select:focus {
    outline: none;
    border-color: #3b82f6;
}


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e8eef5 100%);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(100, 116, 139, 0.08);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #1e293b;
            font-size: 24px;
            font-weight: 600;
        }

        .zone-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zone-selector label {
            color: #475569;
            font-weight: 600;
            font-size: 14px;
        }

        .zone-selector select {
            padding: 8px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #1e293b;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .zone-selector select:focus {
            outline: none;
            border-color: #60a5fa;
        }

        /* Main container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Toolbox */
        #toolbox {
            width: 280px;
            min-width: 200px;
            max-width: 500px;
            background: white;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(100, 116, 139, 0.05);
            position: relative;
            resize: horizontal;
        }

        #toolbox::-webkit-resizer {
            background: #e2e8f0;
            border-radius: 4px;
        }

        .toolbox-section {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
        }

        .toolbox-section h3 {
            color: #1e293b;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tool-button {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            text-align: left;
        }

        .tool-button:hover {
            background: white;
            border-color: #60a5fa;
            transform: translateX(5px);
        }

        .tool-button.active {
            background: #dbeafe;
            border-color: #60a5fa;
        }

        .tool-icon {
            font-size: 24px;
        }

        .tool-label {
            color: #475569;
            font-size: 14px;
            font-weight: 500;
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            
        }

        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .input-group button {
            padding: 8px 16px;
            background: #60a5fa;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .input-group button:hover {
            background: #3b82f6;
        }

        /* Plantillas en grid 2x2 */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .template-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            text-align: center;
        }

        .template-card:hover {
            background: white;
            border-color: #60a5fa;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.2);
        }

        .template-card .tool-icon {
            font-size: 32px;
        }

        .template-card .tool-label {
            font-size: 13px;
            font-weight: 600;
        }

        /* File input hidden */
        #import-file {
            display: none;
        }

        /* Canvas */
          #topology-canvas {
            flex: 1;
            background: white;
            background-image: 
                linear-gradient(rgba(148, 163, 184, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.15) 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
        }

        /* Info Panel */
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.1);
            z-index: 5;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #475569;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-badge {
            background: #f1f5f9;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            color: #1e293b;
        }

        /* Footer */
        .footer {
            background: white;
            padding: 15px 30px;
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 -2px 10px rgba(100, 116, 139, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            z-index: 10;
        }

        .footer-left,
        .footer-right {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid;
            white-space: nowrap;
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border-color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .btn-primary {
            background: #60a5fa;
            color: white;
            border-color: #60a5fa;
        }

        .btn-primary:hover {
            background: #3b82f6;
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .modal-header h2 {
            color: #1e293b;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #94a3b8;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #475569;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #475569;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            color: #1e293b;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f1f5f9;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f8fafc;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        #vm-count {
            flex: 0 0 140px; /* no se estira y ocupa 80px */
            width: 80px;    /* ancho fijo */
        }


    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>Dise√±a tu topolog√≠a de VMs</h1>
        
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Toolbox -->
        <aside id="toolbox">
            <div class="toolbox-section">
                <h3>üñ•Ô∏è VMs Manuales</h3>
                <div class="input-group">
                    <input type="number" id="vm-count" placeholder="Cantidad" min="1" value="1">
                    <button onclick="addManualVMs()">Agregar</button>
                </div>
            </div>

            <div class="toolbox-section">
                <h3>üìê Plantillas</h3>
                <div class="templates-grid">
                    <div class="template-card" onclick="openTemplateModal('star')">
                        <span class="tool-icon">‚ú°</span>
                        <span class="tool-label">Estrella</span>
                    </div>
                    <div class="template-card" onclick="openTemplateModal('ring')">
                        <span class="tool-icon">‚óØ</span>
                        <span class="tool-label">Anillo</span>
                    </div>
                    <div class="template-card" onclick="openTemplateModal('tree')">
                        <span class="tool-icon">ñ£Ç</span>
                        <span class="tool-label">√Årbol</span>
                    </div>
                    <div class="template-card" onclick="openTemplateModal('bus')">
                        <span class="tool-icon">‚îÄ</span>
                        <span class="tool-label">Bus</span>
                    </div>
                    <div class="template-card" onclick="openTemplateModal('mesh')">
                        <span class="tool-icon">üï∏Ô∏è</span>
                        <span class="tool-label">Malla</span>
                    </div>
                </div>
            </div>

            <div class="toolbox-section">
                <h3>üì• Importar</h3>
                <input type="file" id="import-file" accept=".json" onchange="importTopology(event)">
                <button class="tool-button" onclick="document.getElementById('import-file').click()">
                    <span class="tool-icon">üìÇ</span>
                    <span class="tool-label">Importar Topolog√≠a</span>
                </button>
                <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
                    Selecciona un archivo JSON con la topolog√≠a
                </p>
            </div>

            <div class="toolbox-section">
                <h3>üîó Conexiones</h3>
                <button class="tool-button" id="connection-mode-btn" onclick="toggleConnectionMode()">
                    <span class="tool-icon">üîå</span>
                    <span class="tool-label">Modo Conexi√≥n</span>
                </button>
                <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
                    Activa y haz clic en dos VMs para conectarlas
                </p>
            </div>

            <div class="toolbox-section">
                <h3>üóëÔ∏è Eliminar</h3>
                <button class="tool-button" onclick="deleteSelected()">
                    <span class="tool-icon">‚ùå</span>
                    <span class="tool-label">Eliminar Seleccionado</span>
                </button>
                <button class="tool-button" onclick="clearTopology()">
                    <span class="tool-icon">üßπ</span>
                    <span class="tool-label">Limpiar Todo</span>
                </button>
            </div>
        </aside>

        <!-- Canvas -->
        <main id="topology-canvas">
            <div id="info-panel">
                <div class="info-item">
                    <span>VMs:</span>
                    <span class="info-badge" id="vm-count-display">0</span>
                </div>
                <div class="info-item">
                    <span>Conexiones:</span>
                    <span class="info-badge" id="connection-count-display">0</span>
                </div>
                <div class="info-item">
                    <span>Zona:</span>
                    <span class="info-badge" id="zone-display">ZONA-1</span>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-left">
            <button class="btn btn-secondary" onclick="window.location.href='/plantillas'">‚Üê Volver</button>
        </div>
        <div class="footer-right">
            <button class="btn btn-primary" onclick="exportTopology()">Guardar Topolog√≠a</button>
        </div>
    </footer>

    <!-- Modal para Plantillas -->
    <div id="template-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configurar Plantilla</h2>
                <button class="modal-close" onclick="closeTemplateModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Cantidad de VMs</label>
                <input type="number" id="template-vm-count" min="2" value="5">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTemplateModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="applyTemplate()">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Configuraci√≥n de VM -->
    <div id="vm-config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configuraci√≥n de VM</h2>
                <button class="modal-close" onclick="closeVMConfigModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="vm-name" placeholder="VM-001">
            </div>

            <div class="form-group">
                <label>Flavour</label>
                <select id="vm-flavour" onchange="updateFlavourSummary()">
                    <option value="" disabled selected>Seleccionar Flavour</option>
                    <option value="mini">mini</option>
                    <option value="nano">nano</option>
                    <option value="micro">micro</option>
                    <option value="small">small</option>
                    <option value="medium">medium</option>
                    <option value="large">large</option>
                    <option value="xlarge">xlarge</option>
                </select>
            </div>

            <div id="flavour-summary" style="display: none; background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 13px; color: #475569; font-weight: 600; margin-bottom: 8px;">üìã Resumen del Flavour:</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">vCPUs</div>
                        <div id="summary-cpu" style="font-size: 16px; font-weight: 700; color: #1e293b;">-</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">RAM</div>
                        <div id="summary-ram" style="font-size: 16px; font-weight: 700; color: #1e293b;">-</div>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">Disco</div>
                        <div id="summary-disk" style="font-size: 16px; font-weight: 700; color: #1e293b;">-</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Imagen</label>
                <select id="vm-image">
                    <option value="" disabled selected>Seleccionar Imagen</option>
                    <option value="Ubuntu">Ubuntu</option>
                    <option value="CirrOS">CirrOS</option>
                    <option value="Debian">Debian</option>
                    <option value="CentOS">CentOS</option>
                </select>
            </div>

            <div class="form-group"> 
    <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
        <span>Conexi√≥n Externa</span>
        <div style="display: flex; align-items: center; gap: 10px;"> 
            <label class="modern-switch"> 
                <input type="checkbox" id="vm-internet"> 
                <span class="switch-slider"></span> 
            </label> 
            <span id="internet-status" style="font-size: 13px; font-weight: 500; color: #94a3b8; min-width: 35px;">OFF</span> 
        </div>
    </label>
</div>
        <div class="modal-footer"> 
            <button class="btn btn-secondary" onclick="closeVMConfigModal()">Cancelar</button> 
            <button class="btn btn-primary" onclick="saveVMConfig()">Guardar</button> 
        </div> 
        </div>
    </div>

    <!-- Modal para Guardar Topolog√≠a -->
    <div id="save-topology-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Guardar Topolog√≠a</h2>
                <button class="modal-close" onclick="closeSaveModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Nombre del Slice</label>
                <input type="text" id="save-slice-name" placeholder="Ej: Slice prueba">
            </div>
            <div class="form-group">
                <label>Descripci√≥n</label>
                <input type="text" id="save-description" placeholder="Ingresa una breve descripci√≥n">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSaveModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmSaveTopology()">Guardar</button>
            </div>
        </div>
    </div>
    
    <script>
        


        
document.getElementById('vm-internet').addEventListener('change', function() {
    const status = document.getElementById('internet-status');
    if (this.checked) {
        status.textContent = 'ON';
        status.style.color = '#475569';
    } else {
        status.textContent = 'OFF';
        status.style.color = '#94a3b8';
    }
});



        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let network; // Red de vis.js
        let nodes; // DataSet de nodos
        let edges; // DataSet de aristas
        let vmCounter = 0; // Contador para IDs √∫nicos
        let connectionMode = false; // Modo de conexi√≥n activo/inactivo
        let firstNodeSelected = null; // Primer nodo seleccionado para conexi√≥n
        let currentTemplateType = null; // Tipo de plantilla actual
        let selectedNodeId = null; // ID del nodo seleccionado para configurar
        let vmConfigs = {}; // Configuraciones de cada VM
        const PC_IMAGE = '/static/images/pc.png';

        // Flavours cargados desde BD
        let FLAVOURS = {};

        /**
         * Actualiza el resumen del flavour seleccionado
         */
        function updateFlavourSummary() {
            const flavourSelect = document.getElementById('vm-flavour');
            const summaryDiv = document.getElementById('flavour-summary');
            const selectedFlavour = flavourSelect.value;

            if (selectedFlavour && FLAVOURS[selectedFlavour]) {
                const flavour = FLAVOURS[selectedFlavour];
                document.getElementById('summary-cpu').textContent = flavour.cpu;
                document.getElementById('summary-ram').textContent = flavour.ram + ' GB';
                document.getElementById('summary-disk').textContent = flavour.disk + ' GB';
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

function randomXY() {
  const c = document.getElementById('topology-canvas');
  const w = (c?.clientWidth || 1000);
  const h = (c?.clientHeight || 600);
  // Vis.js usa 0,0 en el centro. Espacio reducido para no ir a bordes.
  const x = (Math.random() - 0.5) * w * 0.8;
  const y = (Math.random() - 0.5) * h * 0.8;
  return { x, y };
}


        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initNetwork();
            updateStats();
            
            
        });

        /**
         * Inicializa la red de vis.js
         */
        function initNetwork() {
  const container = document.getElementById('topology-canvas');

  // DataSets
  nodes = new vis.DataSet([]);
  edges = new vis.DataSet([]);
  const data = { nodes, edges };

  const options = {
    nodes: {
      shape: 'image',
      image: PC_IMAGE,
      size: 40,
      font: {
        size: 14,
        color: '#1e293b',
        face: 'Segoe UI',
        background: 'rgba(255, 255, 255, 0.8)',
        strokeWidth: 0
      },
      borderWidth: 2,
      borderWidthSelected: 3,
      chosen: {
        node: function(values) {
          values.borderWidth = 3;
          values.borderColor = '#3b82f6';
        }
      }
    },
    edges: {
      color: { color: '#94a3b8', highlight: '#60a5fa' },
      width: 2,
      smooth: { type: 'continuous' }
    },
    physics: {
      enabled: false  // ‚Üê DESACTIVAMOS la f√≠sica completamente
    },
    interaction: {
      hover: true,
      dragNodes: true,
      tooltipDelay: 150
    }
  };

  network = new vis.Network(container, data, options);

  // Click en nodos
  network.on('click', function(params) {
    if (params.nodes.length > 0) {
      const nodeId = params.nodes[0];
      if (connectionMode) {
        handleConnectionClick(nodeId);
      } else {
        openVMConfigModal(nodeId);
      }
    }
  });
}

        // ============================================
        // AGREGAR VMs MANUALMENTE
        // ============================================
        /**
         * Agrega VMs manualmente seg√∫n la cantidad especificada
         */
        function addManualVMs() {
  const count = parseInt(document.getElementById('vm-count').value) || 1;

  for (let i = 0; i < count; i++) {
    vmCounter++;
    const nodeId = `vm-${vmCounter}`;
    const label = `VM-${String(vmCounter).padStart(3, '0')}`;
    const pos = randomXY();

    nodes.add({
      id: nodeId,
      label: label,
      title: `${label}\nClick para configurar`,
      shape: 'image',
      image: PC_IMAGE,
      x: pos.x,
      y: pos.y,
      fixed: false,
      physics: false  // Sin f√≠sica para que no se mueva autom√°ticamente
    });

    vmConfigs[nodeId] = {
      name: label,
      flavour: 'small',
      cpu: 2,
      ram: 1,
      disk: 6,
      image: 'Ubuntu',
      internet: false
    };
  }

  updateStats();
}


        // ============================================
        // PLANTILLAS DE TOPOLOG√çA
        // ============================================
        /**
         * Abre el modal para seleccionar plantilla
         */
        function openTemplateModal(templateType) {
            currentTemplateType = templateType;
            document.getElementById('template-modal').classList.add('active');
        }

        /**
         * Cierra el modal de plantilla
         */
        function closeTemplateModal() {
            document.getElementById('template-modal').classList.remove('active');
            currentTemplateType = null;
        }

        /**
         * Aplica la plantilla seleccionada
         */
        function applyTemplate() {
            const count = parseInt(document.getElementById('template-vm-count').value) || 5;
            
            switch(currentTemplateType) {
                case 'star':
                    createStarTopology(count);
                    break;
                case 'ring':
                    createRingTopology(count);
                    break;
                case 'tree':
                    createTreeTopology(count);
                    break;
                case 'bus':
                    createBusTopology(count);
                    break;
                case 'mesh':
                    createMeshTopology(count);
                    break;
            }
            
            closeTemplateModal();
            updateStats();
        }

        /**
         * Crea topolog√≠a en estrella
         */
        function createStarTopology(count) {
  if (count < 2) count = 2;

  // Centro aleatorio en el lienzo
  const center = randomXY();
  const centerNodeId = `vm-${++vmCounter}`;

  // Nodo central
  nodes.add({
    id: centerNodeId,
    label: `VM-${String(vmCounter).padStart(3, '0')}\n(Centro)`,
    shape: 'image',
    image: PC_IMAGE,
    x: center.x,
    y: center.y,
    fixed: false,
    physics: false
  });
  vmConfigs[centerNodeId] = getDefaultConfig(`VM-${String(vmCounter).padStart(3, '0')}`);

  // Sat√©lites alrededor en c√≠rculo
  const r = 220; // radio del c√≠rculo
  for (let i = 0; i < count - 1; i++) {
    const nodeId = `vm-${++vmCounter}`;
    const theta = (2 * Math.PI * i) / (count - 1);

    nodes.add({
      id: nodeId,
      label: `VM-${String(vmCounter).padStart(3, '0')}`,
      shape: 'image',
      image: PC_IMAGE,
      x: center.x + r * Math.cos(theta),
      y: center.y + r * Math.sin(theta),
      fixed: false,
      physics: false
    });

    edges.add({ id: `edge-${centerNodeId}-${nodeId}`, from: centerNodeId, to: nodeId });
    vmConfigs[nodeId] = getDefaultConfig(`VM-${String(vmCounter).padStart(3, '0')}`);
  }

  updateStats();
}



        /**
         * Crea topolog√≠a en anillo
         */
        function createRingTopology(count) {
  if (count < 3) count = 3;

  const nodeIds = [];
  const center = randomXY();
  const r = 240; // radio del anillo

  // Nodos ubicados equidistantes en un c√≠rculo
  for (let i = 0; i < count; i++) {
    const nodeId = `vm-${++vmCounter}`;
    const theta = (2 * Math.PI * i) / count;

    nodes.add({
      id: nodeId,
      label: `VM-${String(vmCounter).padStart(3, '0')}`,
      shape: 'image',
      image: PC_IMAGE,
      x: center.x + r * Math.cos(theta),
      y: center.y + r * Math.sin(theta),
      fixed: false,
      physics: false
    });

    nodeIds.push(nodeId);
    vmConfigs[nodeId] = getDefaultConfig(`VM-${String(vmCounter).padStart(3, '0')}`);
  }

  // Aristas del anillo
  for (let i = 0; i < count; i++) {
    const from = nodeIds[i];
    const to = nodeIds[(i + 1) % count];
    edges.add({ id: `edge-${from}-${to}`, from, to });
  }

  updateStats();
}

        /**
         * Crea topolog√≠a de √°rbol binario
         */
        function createTreeTopology(count) {
  const nodeIds = [];
  for (let i = 0; i < count; i++) {
    const nodeId = `vm-${++vmCounter}`;
    const label = i === 0
      ? `VM-${String(vmCounter).padStart(3, '0')}\n(Ra√≠z)`
      : `VM-${String(vmCounter).padStart(3, '0')}`;
    const p = randomXY();
    nodes.add({
      id: nodeId,
      label,
      shape: 'image',
      image: PC_IMAGE,
      x: p.x,
      y: p.y,
      fixed: false,
      physics: false
    });
    nodeIds.push(nodeId);
    vmConfigs[nodeId] = getDefaultConfig(`VM-${String(vmCounter).padStart(3, '0')}`);
  }
  for (let i = 0; i < count; i++) {
    const L = 2 * i + 1, R = 2 * i + 2;
    if (L < count) edges.add({ id: `edge-${nodeIds[i]}-${nodeIds[L]}`, from: nodeIds[i], to: nodeIds[L] });
    if (R < count) edges.add({ id: `edge-${nodeIds[i]}-${nodeIds[R]}`, from: nodeIds[i], to: nodeIds[R] });
  }
}

        /**
         * Crea topolog√≠a en bus
         */
        function createBusTopology(count) {
  const nodeIds = [];
  for (let i = 0; i < count; i++) {
    const nodeId = `vm-${++vmCounter}`;
    const p = randomXY();
    nodes.add({
      id: nodeId,
      label: `VM-${String(vmCounter).padStart(3, '0')}`,
      shape: 'image',
      image: PC_IMAGE,
      x: p.x,
      y: p.y,
      fixed: false,
      physics: false
    });
    nodeIds.push(nodeId);
    vmConfigs[nodeId] = getDefaultConfig(`VM-${String(vmCounter).padStart(3, '0')}`);
  }
  for (let i = 0; i < count - 1; i++) {
    edges.add({ id: `edge-${nodeIds[i]}-${nodeIds[i + 1]}`, from: nodeIds[i], to: nodeIds[i + 1] });
  }
}

        /**
         * Crea topolog√≠a de malla completa
         */
        function createMeshTopology(count) {
  const nodeIds = [];
  for (let i = 0; i < count; i++) {
    const nodeId = `vm-${++vmCounter}`;
    const p = randomXY();
    nodes.add({
      id: nodeId,
      label: `VM-${String(vmCounter).padStart(3, '0')}`,
      shape: 'image',
      image: PC_IMAGE,
      x: p.x,
      y: p.y,
      fixed: false,
      physics: false
    });
    nodeIds.push(nodeId);
    vmConfigs[nodeId] = getDefaultConfig(`VM-${String(vmCounter).padStart(3, '0')}`);
  }
  for (let i = 0; i < count; i++) {
    for (let j = i + 1; j < count; j++) {
      edges.add({ id: `edge-${nodeIds[i]}-${nodeIds[j]}`, from: nodeIds[i], to: nodeIds[j] });
    }
  }
}

        // ============================================
        // MODO CONEXI√ìN MANUAL
        // ============================================
        /**
         * Activa/desactiva el modo de conexi√≥n
         */
        function toggleConnectionMode() {
            connectionMode = !connectionMode;
            const btn = document.getElementById('connection-mode-btn');
            
            if (connectionMode) {
                btn.classList.add('active');
                firstNodeSelected = null;
            } else {
                btn.classList.remove('active');
                firstNodeSelected = null;
            }
        }

        /**
         * Maneja el click en modo conexi√≥n
         */
        function handleConnectionClick(nodeId) {
            if (!firstNodeSelected) {
                firstNodeSelected = nodeId;
                // Resaltar el primer nodo seleccionado
                network.selectNodes([nodeId]);
            } else {
                // Crear conexi√≥n entre los dos nodos
                if (firstNodeSelected !== nodeId) {
                    const edgeId = `edge-${firstNodeSelected}-${nodeId}`;
                    
                    // Verificar si la conexi√≥n ya existe
                    if (!edges.get(edgeId)) {
                        edges.add({
                            id: edgeId,
                            from: firstNodeSelected,
                            to: nodeId
                        });
                        updateStats();
                    }
                }
                
                // Resetear selecci√≥n
                firstNodeSelected = null;
                network.unselectAll();
            }
        }

        // ============================================
        // CONFIGURACI√ìN DE VMs
        // ============================================
        /**
         * Abre el modal de configuraci√≥n de VM
         */
        function openVMConfigModal(nodeId) {
            selectedNodeId = nodeId;
            const config = vmConfigs[nodeId] || getDefaultConfig(nodeId);
            
            // Llenar el formulario con los valores actuales
            document.getElementById('vm-name').value = config.name;
            document.getElementById('vm-flavour').value = config.flavour;
            document.getElementById('vm-image').value = config.image;
            document.getElementById('vm-internet').checked = config.internet || false;
            
            // Actualizar el estado del switch
            const status = document.getElementById('internet-status');
            if (config.internet) {
                status.textContent = 'ON';
                status.style.color = '#475569';
            } else {
                status.textContent = 'OFF';
                status.style.color = '#94a3b8';
            }
            
            // Actualizar resumen del flavour
            updateFlavourSummary();
            
            document.getElementById('vm-config-modal').classList.add('active');
        }

        /**
         * Cierra el modal de configuraci√≥n
         */
        function closeVMConfigModal() {
            document.getElementById('vm-config-modal').classList.remove('active');
            selectedNodeId = null;
        }

        /**
         * Guarda la configuraci√≥n de la VM
         */
        function saveVMConfig() {
            if (!selectedNodeId) return;
            
            const selectedFlavour = document.getElementById('vm-flavour').value;
            
            if (!selectedFlavour || !FLAVOURS[selectedFlavour]) {
                alert('‚ö†Ô∏è Por favor selecciona un flavour');
                return;
            }
            
            const flavourData = FLAVOURS[selectedFlavour];
            
            const config = {
                name: document.getElementById('vm-name').value,
                flavour: selectedFlavour,
                cpu: flavourData.cpu,
                ram: flavourData.ram,
                disk: flavourData.disk,
                image: document.getElementById('vm-image').value,
                internet: document.getElementById('vm-internet').checked
            };
            
            vmConfigs[selectedNodeId] = config;
            
            // Actualizar etiqueta del nodo
            nodes.update({
                id: selectedNodeId,
                label: `${config.name}\n${config.image}`,
                title: `${config.name}\n` +
                       `Flavour: ${config.flavour}\n` +
                       `CPU: ${config.cpu}v | RAM: ${config.ram}GB\n` +
                       `Disco: ${config.disk}GB\n` +
                       `Imagen: ${config.image}\n` +
                       `Internet: ${config.internet ? 'S√≠' : 'No'}`
            });
            
            closeVMConfigModal();
        }

        /**
         * Retorna configuraci√≥n por defecto
         */
        function getDefaultConfig(name) {
            return {
                name: name,
                flavour: 'small',
                cpu: 2,
                ram: 1,
                disk: 6,
                image: 'Ubuntu',
                internet: false
            };
        }

        // ============================================
        // ELIMINACI√ìN
        // ============================================
        /**
         * Elimina el elemento seleccionado
         */
        function deleteSelected() {
            const selectedNodes = network.getSelectedNodes();
            const selectedEdges = network.getSelectedEdges();
            
            if (selectedNodes.length > 0) {
                // Eliminar nodos seleccionados
                selectedNodes.forEach(nodeId => {
                    nodes.remove(nodeId);
                    delete vmConfigs[nodeId];
                });
            }
            
            if (selectedEdges.length > 0) {
                // Eliminar aristas seleccionadas
                edges.remove(selectedEdges);
            }
            
            updateStats();
        }

        /**
         * Limpia toda la topolog√≠a
         */
        function clearTopology() {
            if (confirm('¬øEst√°s seguro de que deseas eliminar toda la topolog√≠a?')) {
                nodes.clear();
                edges.clear();
                vmConfigs = {};
                vmCounter = 0;
                updateStats();
            }
        }

        // ============================================
        // IMPORTAR TOPOLOG√çA
        // ============================================
        /**
         * Importa una topolog√≠a desde un archivo JSON
         */
        function importTopology(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const raw = JSON.parse(e.target.result);

      const topo = raw.topologia ? raw.topologia : raw;
      const recursos = raw.recursos || {};

      // Reset
      nodes.clear();
      edges.clear();
      vmConfigs = {};
      vmCounter = 0;

      // Nodos
      if (Array.isArray(topo.nodes)) {
        topo.nodes.forEach(n => {
          let cfg;
          
          if (recursos[n.id]) {
            // Si viene con recursos del JSON importado
            const rec = recursos[n.id];
            cfg = {
              name: rec.name || n.label || n.id,
              flavour: rec.flavour || 'small',
              cpu: rec.cpu || rec.vcpu || 2,
              ram: rec.ram || rec.ram_gb || 1,
              disk: rec.disk || rec.disk_gb || 6,
              image: rec.image || rec.os || 'Ubuntu',
              internet: rec.internet || false
            };
          } else {
            // Configuraci√≥n por defecto
            cfg = getDefaultConfig(n.label || n.id);
          }

          vmConfigs[n.id] = cfg;

          const title =
            `${cfg.name}\nFlavour: ${cfg.flavour}\n` +
            `CPU: ${cfg.cpu}v | RAM: ${cfg.ram}GB\n` +
            `Disco: ${cfg.disk}GB\nImagen: ${cfg.image}\n` +
            `Internet: ${cfg.internet ? 'S√≠' : 'No'}`;

          // Usa posici√≥n del JSON si viene; si no, random
          const p = (n.position && typeof n.position.x === 'number' && typeof n.position.y === 'number')
            ? { x: n.position.x, y: n.position.y }
            : randomXY();

          nodes.add({
            id: n.id,
            label: n.label || cfg.name,
            title,
            shape: 'image',
            image: PC_IMAGE,
            x: p.x,
            y: p.y,
            fixed: false,
            physics: false  // Sin f√≠sica para que no se mueva
          });

          const m = String(n.id).match(/vm-(\d+)/);
          if (m) vmCounter = Math.max(vmCounter, parseInt(m[1], 10));
        });
      }

      // Aristas
      if (Array.isArray(topo.edges)) {
        topo.edges.forEach(e2 => {
          edges.add({ id: e2.id, from: e2.from, to: e2.to });
        });
      }

      // Metadata opcional
      if (raw.metadata?.zone) {
        const zsel = document.getElementById('zone-select');
        if (zsel) zsel.value = raw.metadata.zone;
        const zdisp = document.getElementById('zone-display');
        if (zdisp) zdisp.textContent = raw.metadata.zone;
      }

      updateStats();
      alert('‚úÖ Topolog√≠a importada exitosamente');
    } catch (err) {
      console.error('Error al importar:', err);
      alert('‚ùå Error al importar topolog√≠a: ' + err.message);
    }
  };

  reader.readAsText(file);
  event.target.value = '';
}






        // ============================================
        // EXPORTACI√ìN
        // ============================================
        /**
         * Exporta la topolog√≠a a JSON
         */
        
        function exportTopology() {
  try {
    // Validaci√≥n m√≠nima
    const totalNodes = nodes ? nodes.get().length : 0;
    if (!totalNodes) {
      alert('‚ö†Ô∏è No hay VMs para exportar');
      return;
    }
    
    // Abrir el modal en lugar de exportar directamente
    document.getElementById('save-topology-modal').classList.add('active');

  } catch (err) {
    console.error('Error exportando topolog√≠a:', err);
    alert('Error al exportar. Revisa la consola.');
  }
} 


/**
 * Cierra el modal de guardar
 */
function closeSaveModal() {
    document.getElementById('save-topology-modal').classList.remove('active');
    document.getElementById('save-slice-name').value = '';
    document.getElementById('save-description').value = '';
}

/**
 * Confirma y guarda la topolog√≠a con los datos del modal
 */
function confirmSaveTopology() {
  const sliceName = document.getElementById('save-slice-name').value.trim();
  const description = document.getElementById('save-description').value.trim();

  if (!sliceName) {
    alert('‚ö†Ô∏è Por favor ingresa el nombre del slice');
    return;
  }

  const topologia = { nodes: nodes.get(), edges: edges.get() };
  const recursos  = vmConfigs;

  const payload = {
    slice_name: sliceName,
    description: description,
    topologia: topologia,
    recursos: recursos
  };

  fetch("/templates", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",                // üî¥ IMPORTANTE: env√≠a la cookie de sesi√≥n
    body: JSON.stringify(payload)
  })
  .then(async (res) => {
    if (!res.ok) {
      // intenta leer detalle de FastAPI
      let msg = "Error al guardar template";
      try {
        const data = await res.json();
        if (data?.detail) msg = data.detail;
      } catch (_) {}
      throw new Error(msg);
    }
    return res.json();
  })
  .then((data) => {
    alert("‚úÖ Template guardado correctamente");
    window.location.href = "/plantillas";  // redirige
  })
  .catch((err) => {
    console.error(err);
    alert("‚ùå Error guardando template: " + err.message);
  });
}

        // ============================================
        // UTILIDADES
        // ============================================
        /**
         * Actualiza las estad√≠sticas del panel
         */
        function updateStats() {
  const vmBadge = document.getElementById('vm-count-display');
  const edgeBadge = document.getElementById('connection-count-display');

  const n = nodes ? nodes.get().length : 0;
  const e = edges ? edges.get().length : 0;

  if (vmBadge) vmBadge.textContent = n;
  if (edgeBadge) edgeBadge.textContent = e;
}
// Mapa global (ya lo tienes declarado)
  // let FLAVOURS = {};

  async function loadFlavours() {
    try {
      const res = await fetch('/flavours', {
        credentials: 'include' // <- env√≠a el cookie de sesi√≥n
      });

      if (!res.ok) {
        console.error('No se pudieron cargar los flavours:', res.status);
        return;
      }

      const data = await res.json(); // [{flavour_id, name, vcpu, ram_gb, disk_gb}, ...]

      // Rellenar mapa y <select>
      FLAVOURS = {};
      const sel = document.getElementById('vm-flavour');

      // Opcional: reiniciar opciones y dejar un placeholder
      sel.innerHTML = '<option value="" disabled selected>Seleccionar Flavour</option>';

      data.forEach(f => {
        FLAVOURS[f.name] = {
          cpu: f.vcpu,
          ram: Number(f.ram_gb),
          disk: Number(f.disk_gb)
        };
        const opt = document.createElement('option');
        opt.value = f.name;
        opt.textContent = f.name;
        sel.appendChild(opt);
      });

      // Si ya hab√≠a uno seleccionado, refresca el resumen
      updateFlavourSummary();
    } catch (e) {
      console.error('Error cargando flavours:', e);
    }
  }

  // L√°nzalo al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    initNetwork();
    updateStats();
    loadFlavours();   // <- AQU√ç
  });

  // Tu funci√≥n ya existente; solo aseg√∫rate que usa las claves cpu/ram/disk
  function updateFlavourSummary() {
    const flavourSelect = document.getElementById('vm-flavour');
    const summaryDiv = document.getElementById('flavour-summary');
    const selectedFlavour = flavourSelect.value;

    if (selectedFlavour && FLAVOURS[selectedFlavour]) {
      const f = FLAVOURS[selectedFlavour];
      document.getElementById('summary-cpu').textContent = f.cpu;
      document.getElementById('summary-ram').textContent = f.ram + ' GB';
      document.getElementById('summary-disk').textContent = f.disk + ' GB';
      summaryDiv.style.display = 'block';
    } else {
      summaryDiv.style.display = 'none';
    }
  }







    </script>




</body>





</html>