<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal VNC</title>
    <script type="module" crossorigin="anonymous">
        import RFB from 'https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js';
        
        let rfb;
        let vmData = null;
        let vncPort = null;
        let vmId = {{ vm_id }};  // Variable global con el ID de la VM
        
        async function loadVMData() {
            try {
                // Cargar datos de la VM
                const response = await fetch(`http://10.20.12.26:8001/api/v1/vms/${vmId}`);
                if (!response.ok) throw new Error('VM no encontrada');
                
                vmData = await response.json();
                
                // Obtener puerto VNC
                const vncResponse = await fetch(`http://10.20.12.26:8001/api/v1/vnc-ports/?vm_id=${vmId}`);
                if (!vncResponse.ok) throw new Error('Puerto VNC no encontrado');
                
                const ports = await vncResponse.json();
                if (!ports || ports.length === 0) {
                    throw new Error('VM sin puerto VNC asignado');
                }
                vncPort = ports[0];
                
                // Actualizar título
                document.getElementById('vm-title').textContent = vmData.name || `VM-${vmId}`;
                document.getElementById('vm-info').textContent = `${vmData.vcpu || 1} vCPU · ${vmData.ram_mb || 0}MB RAM · ${vmData.status || 'unknown'}`;
                
                // Conectar VNC directamente al websockify del worker
                connectVNC();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
                document.getElementById('status').style.color = '#ef4444';
            }
        }
        
        function connectVNC() {
            try {
                document.getElementById('status').textContent = 'Conectando a VNC...';
                
                // Calcular puerto externo en el gateway según worker_ip
                let gatewayPort;
                const vncPortNumber = vncPort.port_number;
                const offset = vncPortNumber - 5900; // 0-50
                
                if (vmData.worker_ip === '192.168.201.1') {
                    // Server 1 → Gateway puertos 7000-7050
                    gatewayPort = 7000 + offset;
                } else if (vmData.worker_ip === '192.168.201.2') {
                    // Server 2 → Gateway puertos 8000-8050
                    gatewayPort = 8000 + offset;
                } else if (vmData.worker_ip === '192.168.201.3') {
                    // Server 3 → Gateway puertos 9000-9050
                    gatewayPort = 9000 + offset;
                } else {
                    throw new Error('Worker IP no reconocido: ' + vmData.worker_ip);
                }
                
                // Conectar al gateway que redirige via iptables al websockify del server
                const wsUrl = `ws://10.20.12.209:${gatewayPort}`;
                
                console.log('VM ID:', vmId);
                console.log('Worker IP:', vmData.worker_ip);
                console.log('Puerto VNC:', vncPortNumber);
                console.log('Puerto Gateway:', gatewayPort);
                console.log('URL WebSocket:', wsUrl);
                
                rfb = new RFB(document.getElementById('vnc-screen'), wsUrl, {
                    credentials: { password: '' },
                    shared: true,
                    repeaterID: '',
                    wsProtocols: ['binary']
                });
                
                rfb.addEventListener('connect', () => {
                    document.getElementById('status').textContent = 'Conectado';
                    document.getElementById('status').style.color = '#10b981';
                    console.log('VNC conectado');
                });
                
                rfb.addEventListener('disconnect', (e) => {
                    const errorMsg = e.detail.clean ? 'Limpio' : 'Error de conexión';
                    document.getElementById('status').textContent = `Desconectado: ${errorMsg}`;
                    document.getElementById('status').style.color = '#ef4444';
                    console.error('❌ VNC desconectado:', e);
                    console.error('Detalles del error:', JSON.stringify(e.detail, null, 2));
                    
                    // Mostrar mensaje útil al usuario
                    if (!e.detail.clean) {
                        alert(`❌ ERROR DE CONEXIÓN VNC\n\n` +
                              `VM ID: ${vmId}\n\n` +
                              `Posibles causas:\n` +
                              `1. Websockify NO está corriendo en el server\n` +
                              `2. La VM no tiene VNC activo\n` +
                              `3. Problema de red/firewall\n\n` +
                              `Revisa la consola del navegador (F12) para más detalles.`);
                    }
                });
                
                rfb.addEventListener('credentialsrequired', () => {
                    const password = prompt('Contraseña VNC:');
                    if (password) {
                        rfb.sendCredentials({ password: password });
                    }
                });
                
                rfb.scaleViewport = true;
                rfb.resizeSession = false;
                
            } catch (error) {
                console.error('Error al conectar VNC:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
                document.getElementById('status').style.color = '#ef4444';
            }
        }
        
        function disconnect() {
            if (rfb) {
                rfb.disconnect();
                rfb = null;
            }
        }
        
        function sendCtrlAltDel() {
            if (rfb) {
                rfb.sendCtrlAltDel();
            }
        }
        
        window.addEventListener('load', loadVMData);
        window.addEventListener('beforeunload', disconnect);
        
        // Exportar funciones globalmente
        window.sendCtrlAltDel = sendCtrlAltDel;
        window.disconnect = disconnect;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e293b;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: #0f172a;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }
        
        .header-left h1 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .header-left p {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .status-bar {
            background: #0f172a;
            color: #94a3b8;
            padding: 8px 20px;
            font-size: 12px;
            border-top: 1px solid #334155;
        }
        
        #vnc-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1e293b;
            overflow: hidden;
        }
        
        #vnc-screen {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1 id="vm-title">Terminal VNC</h1>
            <p id="vm-info">Cargando...</p>
        </div>
        <div class="controls">
            <button class="btn" onclick="sendCtrlAltDel()">Ctrl+Alt+Del</button>
            <button class="btn btn-danger" onclick="window.close()">Cerrar</button>
        </div>
    </div>
    
    <div id="vnc-container">
        <div id="vnc-screen"></div>
    </div>
    
    <div class="status-bar">
        Estado: <span id="status">Inicializando...</span>
    </div>
</body>
</html>
